{% extends "base.html" %}

{% block title %}Checkout | KropKart{% endblock %}

{% block content %}
<div class="animate-fade" style="max-width: 800px; margin: 0 auto;">
    <div class="card">
        <div class="flex-between mb-4" style="border-bottom: 2px solid var(--gray-100); padding-bottom: 1rem;">
            <h2 class="text-primary"><i class="fas fa-shopping-cart"></i> Secure Checkout</h2>
            <span class="badge badge-ai"><i class="fas fa-shield-alt"></i> Razorpay Secured</span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <!-- Product Image -->
            <div style="border-radius: 1rem; overflow: hidden; background: var(--gray-100); height: 250px;">
                {% if product.image %}
                <img src="{{ product.image }}" class="img-cover" alt="{{ product.name }}">
                {% else %}
                <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                    <i class="fas fa-box fa-4x" style="color: var(--gray-300);"></i>
                </div>
                {% endif %}
            </div>

            <!-- Product Details -->
            <div>
                <h3 style="margin-bottom: 0.5rem; font-size: 1.5rem;">{{ product.name }}</h3>
                <span class="badge" style="background: var(--light); color: var(--primary); margin-bottom: 1rem;">
                    {{ product.category }}
                </span>

                <p class="text-muted" style="margin-bottom: 1.5rem; line-height: 1.6;">{{ product.description }}</p>

                <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem;">
                    <div class="flex-between mb-2">
                        <span class="text-muted">Base Price</span>
                        <span>₹{{ product.price }}</span>
                    </div>
                    <div class="flex-between mb-2">
                        <span class="text-muted">AI Quality Adjustment</span>
                        <span class="text-primary">+ ₹{{ ((product.adjusted_price|float) -
                            (product.price|float))|round(2) }}</span>
                    </div>
                    <div class="flex-between"
                        style="border-top: 1px solid var(--gray-200); padding-top: 0.5rem; margin-top: 0.5rem; font-weight: 800; font-size: 1.2rem;">
                        <span>Total Pay</span>
                        <span>₹{{ product.adjusted_price }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Actions -->
        <div style="text-align: right;">
            <a href="/dashboard" class="btn btn-secondary" style="margin-right: 1rem;">Cancel</a>
            <button id="payBtn" class="btn btn-primary"
                style="padding: 0.8rem 2rem; font-size: 1.1rem; border: none; cursor: pointer; border-radius: 0.75rem;">
                <i class="fas fa-lock"></i> Pay ₹{{ product.adjusted_price }} Now
            </button>
        </div>
    </div>
</div>

<script>
    // Configuration from Server - Using tojson for maximum safety
    const CONFIG = {
        razorpayKey: {{ RAZORPAY_KEY_ID| tojson }},
    productId: { { product._id | tojson } },
    productName: { { product.name | tojson } },
    amount: parseFloat({{ product.adjusted_price | tojson }}),
        userEmail: { { session.get('user', '') | tojson } },
    userName: { { session.get('name', 'Customer') | tojson } }
    };

    console.log("KropKart Payment Config Loaded:", CONFIG);

    const payButton = document.getElementById('payBtn');

    if (payButton) {
        payButton.addEventListener('click', async function (e) {
            e.preventDefault();

            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
            this.disabled = true;

            try {
                // Check if Razorpay is loaded
                if (typeof Razorpay === 'undefined') {
                    throw new Error("Razorpay payment system is still loading. Please wait 2 seconds and try again.");
                }

                console.log("Requesting order creation for:", CONFIG.amount);

                // 1. Create Order on Server
                const orderRes = await fetch('/create_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: CONFIG.amount })
                });

                const orderData = await orderRes.json();

                if (!orderRes.ok) {
                    throw new Error(orderData.error || "Server could not create the order. Check your internet.");
                }

                if (!orderData.id) {
                    throw new Error("Invalid response from payment server.");
                }

                console.log("Order created successfully:", orderData.id);

                // 2. Open Razorpay Checkout Modal
                const options = {
                    key: CONFIG.razorpayKey,
                    amount: orderData.amount, // in paise
                    currency: "INR",
                    name: "KropKart Marketplace",
                    description: "Payment for " + CONFIG.productName,
                    order_id: orderData.id,
                    handler: async function (response) {
                        payButton.innerHTML = '<i class="fas fa-check-circle"></i> Verifying...';
                        console.log("Payment received, verifying with server...");

                        try {
                            const verifyRes = await fetch('/verify_payment', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    product_id: CONFIG.productId,
                                    amount: CONFIG.amount,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_signature: response.razorpay_signature
                                })
                            });

                            const result = await verifyRes.json();

                            if (result.status === 'success') {
                                alert("✅ Payment Successful! Your order has been placed.");
                                window.location.href = "/dashboard";
                            } else {
                                throw new Error(result.message || "Payment verification failed.");
                            }
                        } catch (err) {
                            console.error("Verification Error:", err);
                            alert("⚠️ Payment was successful but verification failed: " + err.message);
                            payButton.innerHTML = originalText;
                            payButton.disabled = false;
                        }
                    },
                    prefill: {
                        name: CONFIG.userName,
                        email: CONFIG.userEmail
                    },
                    theme: { color: "#166534" },
                    modal: {
                        ondismiss: function () {
                            console.log("Payment window closed by user.");
                            payButton.innerHTML = originalText;
                            payButton.disabled = false;
                        }
                    }
                };

                const rzp = new Razorpay(options);

                rzp.on('payment.failed', function (response) {
                    console.error("Payment Failed:", response.error);
                    alert("❌ Payment Failed: " + response.error.description);
                    payButton.innerHTML = originalText;
                    payButton.disabled = false;
                });

                rzp.open();

            } catch (err) {
                console.error("Checkout Error:", err);
                alert("Payment Error: " + err.message);
                this.innerHTML = originalText;
                this.disabled = false;
            }
        });
    } else {
        console.error("Pay button not found on page!");
    }
</script>
{% endblock %}